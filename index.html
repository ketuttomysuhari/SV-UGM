<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>IFC â†’ Cesium | Pick, Zoom to GUID, IFC Georeferencing</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <script src="https://cesium.com/downloads/cesiumjs/releases/1.130/Build/Cesium/Cesium.js"></script>
  <link href="https://cesium.com/downloads/cesiumjs/releases/1.130/Build/Cesium/Widgets/widgets.css" rel="stylesheet" />
  <style>
    html, body, #cesiumContainer { width:100%; height:100%; margin:0; padding:0; overflow:hidden; }
    .ui { position:absolute; top:10px; left:10px; z-index:1000; display:flex; gap:8px; align-items:center; }
    .card { background:#ffffffd9; backdrop-filter: blur(6px); border:1px solid #e5e7eb; border-radius:12px; padding:10px 12px; box-shadow:0 4px 14px rgba(0,0,0,.08); }
    .row { display:flex; gap:6px; align-items:center; }
    .row input, .row button, .row label { font: 13px/1.3 system-ui, sans-serif; }
    .row input[type="text"] { padding:6px 8px; border:1px solid #d1d5db; border-radius:8px; min-width:280px; }
    .row button { padding:6px 10px; border:1px solid #d1d5db; background:white; border-radius:8px; cursor:pointer; }
    .row button:hover { background:#f3f4f6; }
    .info { position:absolute; bottom:12px; left:12px; z-index:1000; max-width:420px; }
    .info pre { margin:0; font: 12px/1.35 ui-monospace, monospace; white-space:pre-wrap; }
    .badge { display:inline-block; font-size:11px; padding:2px 6px; border-radius:999px; background:#eef2ff; border:1px solid #c7d2fe; color:#3730a3; margin-right:6px; }
    .logo { position:absolute; bottom:16px; right:16px; z-index:1000; opacity:0.9; }
    .logo img { width:140px; }
  </style>
</head>
<body>
  <div id="cesiumContainer"></div>
  <div class="ui card">
    <div class="row">
      <span class="badge">Query</span>
      <input id="guidInput" type="text" placeholder="Enter IfcGUID" />
      <button id="applyGuid">Apply</button>
    </div>
  </div>
  <div class="info card">
    <div style="font-weight:600; margin-bottom:6px;">Picked feature</div>
    <pre id="pickedInfo">Click an element...</pre>
  </div>
  <div class="logo"><img src="https://sv.ugm.ac.id/wp-content/uploads/sites/27/2021/09/Lambang-UGM-putih.png" alt="logo"/></div>

  <script type="module">
    Cesium.Ion.defaultAccessToken = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJqdGkiOiJiNDJhNGIzMy1lYjk1LTQ5MTgtOGIxMy1iMjNkYWFjZTZjZGMiLCJpZCI6MzA1NDUzLCJpYXQiOjE3NDk4ODQ0NjF9.ZzfqWk4Sc_3zrTXoyumAzAVH4QavWxwZ5kLWHN6KZ4E';
    const viewer = new Cesium.Viewer('cesiumContainer', {
      terrain: Cesium.Terrain.fromWorldTerrain(),
      animation:false, timeline:false, homeButton:false,
      sceneModePicker:false, geocoder:true, baseLayerPicker:true,
      navigationHelpButton:false, fullscreenButton:true,
      selectionIndicator:false, infoBox:false
    });
    viewer.camera.flyTo({
      destination: Cesium.Cartesian3.fromDegrees(110.37394, -7.77463, 400),
      orientation: { heading: Cesium.Math.toRadians(0.0), pitch: Cesium.Math.toRadians(-90.0) }
    });

    const tileset = await Cesium.Cesium3DTileset.fromIonAssetId(3591078);
    viewer.scene.primitives.add(tileset);
    await tileset.readyPromise;

    let lastColored = [];
    function clearHighlight(){ lastColored.forEach(f=>f.color=Cesium.Color.WHITE); lastColored=[]; }
    function highlightFeature(feature){ feature.color=Cesium.Color.YELLOW; lastColored.push(feature); }

    const handler = new Cesium.ScreenSpaceEventHandler(viewer.scene.canvas);
    handler.setInputAction((click) => {
      const picked = viewer.scene.pick(click.position);
      if(!picked || !picked.getProperty) return;
      clearHighlight(); highlightFeature(picked);
      const cart = viewer.scene.pickPosition(click.position);
      let coordText = 'n/a';
      if(Cesium.defined(cart)){
        const carto = Cesium.Cartographic.fromCartesian(cart);
        coordText = `lon:${Cesium.Math.toDegrees(carto.longitude).toFixed(7)}\nlat:${Cesium.Math.toDegrees(carto.latitude).toFixed(7)}\nh:${carto.height.toFixed(3)} m`;
        viewer.camera.flyTo({
          destination: Cesium.Cartesian3.fromRadians(carto.longitude, carto.latitude, Math.max(8, carto.height+20)),
          orientation:{ heading:viewer.camera.heading, pitch:Cesium.Math.toRadians(-35)}, duration:0.9
        });
      }
      const props = {}; (picked.getPropertyIds()||[]).forEach(id=>props[id]=picked.getProperty(id));
      document.getElementById('pickedInfo').textContent = JSON.stringify(props,null,2)+`\n${coordText}`;
    }, Cesium.ScreenSpaceEventType.LEFT_CLICK);

    document.getElementById('applyGuid').addEventListener('click',()=>{
      const guid = document.getElementById('guidInput').value.trim();
      if(!guid){ tileset.style=undefined; return; }
      const style = new Cesium.Cesium3DTileStyle({ color: `(${["${IfcGuid}","${GlobalId}","${IFC_GUID}","${elementId}"].map(f=>`(${f}=='${guid}')`).join(' || ')}) ? color('yellow') : color('white')` });
      tileset.style=style;
      const positions=[];
      tileset.tileVisible.addEventListener(tile=>{
        tile.content.featuresLength && [...Array(tile.content.featuresLength).keys()].forEach(i=>{
          const f=tile.content.getFeature(i);
          if([f.getProperty('IfcGuid'),f.getProperty('GlobalId'),f.getProperty('IFC_GUID'),f.getProperty('elementId')].includes(guid)){
            const center=Cesium.BoundingSphere.fromPoints([f.boundingVolume.boundingVolume.center]);
            positions.push(center);
          }
        });
      });
      if(positions.length){ viewer.camera.flyToBoundingSphere(Cesium.BoundingSphere.fromPoints(positions),{duration:1.5}); }
    });
  </script>
</body>
</html>

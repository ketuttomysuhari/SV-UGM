<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>IFC → Cesium | Click Colors, Preloader, Picking & Stats</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <script src="https://cesium.com/downloads/cesiumjs/releases/1.130/Build/Cesium/Cesium.js"></script>
  <link href="https://cesium.com/downloads/cesiumjs/releases/1.130/Build/Cesium/Widgets/widgets.css" rel="stylesheet" />
  <style>
    html, body, #cesiumContainer { width:100%; height:100%; margin:0; padding:0; overflow:hidden; }
    #cesiumContainer { opacity: 0; transition: opacity .8s ease; }
    #cesiumContainer.show { opacity: 1; }

    .ui-left { position:absolute; top:10px; left:10px; z-index:1000; display:flex; gap:8px; align-items:center; }
    .ui-right { position:absolute; top:66px; right:10px; z-index:1000; display:flex; flex-direction:column; gap:8px; }
    .card { background:#ffffffd9; backdrop-filter: blur(6px); border:1px solid #e5e7eb; border-radius:12px; padding:10px 12px; box-shadow:0 4px 14px rgba(0,0,0,.08); }
    .row { display:flex; gap:6px; align-items:center; flex-wrap:wrap; }
    .row input, .row button, .row select { font: 13px/1.3 system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, sans-serif; }
    .row input[type="text"] { padding:6px 8px; border:1px solid #d1d5db; border-radius:8px; min-width:220px; }
    .row button { padding:6px 10px; border:1px solid #d1d5db; background:white; border-radius:8px; cursor:pointer; }
    .row button:hover { background:#f3f4f6; }
    .badge { display:inline-block; font-size:11px; padding:2px 6px; border-radius:999px; background:#eef2ff; border:1px solid #c7d2fe; color:#3730a3; margin-right:6px; }
    .pre { margin:0; font: 12px/1.35 ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace; white-space:pre-wrap; }
    .logo { position:absolute; bottom:16px; right:16px; z-index:1000; opacity:0.9; }
    .logo img { width:140px; }

    .preloader{position:fixed;inset:0;background:#0b1020;display:flex;align-items:center;justify-content:center;z-index:2000;}
    .pre-card{display:flex;flex-direction:column;align-items:center;gap:8px;color:#fff;text-align:center}
    .pre-logo{width:120px;filter:drop-shadow(0 2px 14px rgba(0,0,0,.35))}
    .pre-title{font:600 18px/1.2 system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,sans-serif;letter-spacing:.2px}
    .pre-bar{width:320px;height:10px;background:rgba(255,255,255,.18);border-radius:999px;overflow:hidden}
    .pre-fill{height:100%;width:0%;background:#fbbf24}
    .pre-percent{font:12px;opacity:.9}
    .preloader.hide{opacity:0;transition:opacity .6s ease;pointer-events:none}

    canvas { cursor: crosshair; }
    .room-btn.active{ outline:2px solid #10b981; }
  </style>
</head>
<body>
  <div id="cesiumContainer"></div>

  <!-- LEFT: Search & Actions -->
  <div class="ui-left card">
    <div class="row">
      <span class="badge">GUID</span>
      <input id="guidInput" type="text" placeholder="IfcGUID" />
      <button id="btnGuid">Highlight & Fly</button>
      <span class="badge">Room</span>
      <input id="roomInput" type="text" placeholder="Exact/Partial (e.g., MUSHOLA)" />
      <button id="btnRoom">Find Room</button>
      <span class="badge">Floor</span>
      <select id="floorFilter" style="padding:6px 8px; border:1px solid #d1d5db; border-radius:8px; min-width:140px">
        <option value="">All</option>
      </select>
      <button id="btnFloor">Apply Floor</button>
      <button id="btnScan">Scan Stats</button>
      <button id="btnClear">Clear highlight</button>
    </div>
  </div>

  <!-- RIGHT: Info & Stats -->
  <div class="ui-right">
    <div class="card">
      <div style="font-weight:600; margin-bottom:6px;">Picked feature</div>
      <pre id="pickedInfo" class="pre">Click an element…</pre>
      <div style="margin-top:6px; max-height:220px; overflow:auto">
        <table id="attrTable" style="width:100%; border-collapse:collapse; font:12px/1.35 ui-monospace">
          <thead><tr><th style="text-align:left; border-bottom:1px solid #e5e7eb">Key</th><th style="text-align:left; border-bottom:1px solid #e5e7eb">Value</th></tr></thead>
          <tbody></tbody>
        </table>
      </div>
    </div>
    <div class="card">
      <div style="font-weight:600; margin-bottom:6px;">Model stats</div>
      <pre id="stats" class="pre">Windows: 0 | Doors: 0 | Storeys: -
(Press "Scan Stats")</pre>
    </div>
    <div class="card">
      <div style="font-weight:600; margin-bottom:6px;">Floors & Rooms</div>
      <div id="levelsPanel" class="pre">(Press "Scan Stats" to list floors & rooms)</div>
    </div>
  </div>

  <!-- PRELOADER OVERLAY -->
  <div id="preloader" class="preloader">
    <div class="pre-card">
      <img class="pre-logo" src="https://sv.ugm.ac.id/wp-content/uploads/sites/27/2021/09/Lambang-UGM-putih.png" alt="UGM"/>
      <div class="pre-title">Pengelolaan Aset Warisan Budaya</div>
      <div class="pre-bar"><div class="pre-fill" id="preFill"></div></div>
      <div class="pre-percent" id="prePct">1%</div>
    </div>
  </div>

  <div class="logo"><img src="https://sv.ugm.ac.id/wp-content/uploads/sites/27/2021/09/Lambang-UGM-putih.png" alt="logo"/></div>

  <script type="module">
    // ========= Preloader (5s, non-blocking) =========
    const preEl = document.getElementById('preloader');
    const preFill = document.getElementById('preFill');
    const prePct = document.getElementById('prePct');
    let pct = 0;
    const preId = setInterval(() => {
      pct = Math.min(100, pct + 1); // 100 * 50ms = 5000ms
      preFill.style.width = pct + '%';
      prePct.textContent = pct + '%';
      if (pct >= 100) {
        clearInterval(preId);
        preEl.classList.add('hide');
        setTimeout(() => {
          preEl.remove();
          document.getElementById('cesiumContainer').classList.add('show');
        }, 700);
      }
    }, 50);

    // ===================== Init Cesium =====================
    Cesium.Ion.defaultAccessToken = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJqdGkiOiJiNDJhNGIzMy1lYjk1LTQ5MTgtOGIxMy1iMjNkYWFjZTZjZGMiLCJpZCI6MzA1NDUzLCJpYXQiOjE3NDk4ODQ0NjF9.ZzfqWk4Sc_3zrTXoyumAzAVH4QavWxwZ5kLWHN6KZ4E';
    const viewer = new Cesium.Viewer('cesiumContainer',{
      terrain: Cesium.Terrain.fromWorldTerrain(),
      animation:false,timeline:false,homeButton:false,sceneModePicker:false,
      geocoder:true,baseLayerPicker:true,navigationHelpButton:false,fullscreenButton:true,
      selectionIndicator:false,infoBox:false
    });
    viewer.scene.pickTranslucentDepth = true;
    viewer.scene.globe.depthTestAgainstTerrain = false;
    viewer.scene.shadowMap.enabled = true;
    viewer.shadows = true;
    viewer.scene.highDynamicRange = true;
    viewer.scene.globe.enableLighting = true;
    viewer.camera.flyTo({
      destination: Cesium.Cartesian3.fromDegrees(110.37394,-7.77463,400),
      orientation:{heading:Cesium.Math.toRadians(0),pitch:Cesium.Math.toRadians(-90)}
    });

    // Load tileset (non-blocking)
    const tileset = await Cesium.Cesium3DTileset.fromIonAssetId(3591078);
    viewer.scene.primitives.add(tileset);
    tileset.readyPromise
      .then(() => { viewer.zoomTo(tileset); viewer.scene.requestRender(); })
      .catch((e) => console.error('Tileset failed to load:', e));

    // ===================== Helpers =====================
    const pickedInfo = document.getElementById('pickedInfo');
    const statsBox = document.getElementById('stats');

    function escapeHtml(s){ return String(s).replace(/[&<>"']/g, (c)=>({"&":"&amp;","<":"&lt;",">":"&gt;","\"":"&quot;","'":"&#39;"}[c])); }

    // Color cycling palette
    const palette = [
      Cesium.Color.YELLOW,
      Cesium.Color.CYAN,
      Cesium.Color.MAGENTA,
      Cesium.Color.LIME,
      Cesium.Color.ORANGE
    ];

    // Track colored features by stable key (prefer IfcGUID)
    const colorIndexByKey = new Map();
    const featureByKey = new Map();

    function featureKey(f){
      try {
        const guid = f.getProperty('IfcGuid')||f.getProperty('GlobalId')||f.getProperty('IFC_GUID')||f.getProperty('elementId');
        if (guid) return 'guid:'+String(guid);
      } catch {}
      if (typeof f.getFeatureId === 'function') {
        try { return 'fid:'+f.getFeatureId(); } catch {}
      }
      if (typeof f.featureId === 'number') return 'fid:'+f.featureId;
      if (typeof f._batchId === 'number') return 'bid:'+f._batchId; // legacy fallback
      return 'rand:'+Math.random();
    }

    function setFeatureColor(f, color){
      try { f.color = color; } catch {}
    }

    function clearAllHighlights(){
      for (const [k,f] of featureByKey.entries()) { try { f.color = Cesium.Color.WHITE; } catch {} }
      colorIndexByKey.clear();
      featureByKey.clear();
      tileset.style = undefined;
      pickedInfo.textContent = 'Cleared.';
      const tbody=document.querySelector('#attrTable tbody');
      if(tbody) tbody.innerHTML='';
    }

    function flyToCartesian(cart){
      if (!Cesium.defined(cart)) return;
      const c = Cesium.Cartographic.fromCartesian(cart);
      viewer.camera.flyTo({
        destination: Cesium.Cartesian3.fromRadians(c.longitude,c.latitude, Math.max(8,c.height+18)),
        orientation: { heading: viewer.camera.heading, pitch: Cesium.Math.toRadians(-35), roll: 0 },
        duration: 0.8
      });
    }

    // ===================== Picking with color cycling =====================
    const handler=new Cesium.ScreenSpaceEventHandler(viewer.scene.canvas);
    let lastPickCarto = null;

    handler.setInputAction((click)=>{
      const picks = viewer.scene.drillPick(click.position);
      let picked = null;
      for(const p of picks){ if(typeof p.getProperty==='function'){ picked = p; break; } }
      if(!picked) return;

      const key = featureKey(picked);
      const cur = colorIndexByKey.get(key) ?? -1;
      const next = (cur + 1) % palette.length; // cycle
      colorIndexByKey.set(key, next);
      featureByKey.set(key, picked);
      setFeatureColor(picked, palette[next]);

      const cart=viewer.scene.pickPosition(click.position);
      if(Cesium.defined(cart)){
        lastPickCarto = Cesium.Cartographic.fromCartesian(cart);
      }

      // Show properties
      const props={};
      const ids=(picked.getPropertyIds&&picked.getPropertyIds())||[];
      for(const id of ids){ try{ props[id]=picked.getProperty(id);}catch{} }
      const ifcGuid=props.IfcGuid||props.IFC_GUID||props.GlobalId||props.globalId||props.elementId;
      const ifcType=props.IfcType||props.ifcClass||props.class||props.Type||props.Category;
      const coordText = lastPickCarto
        ? `lon: ${Cesium.Math.toDegrees(lastPickCarto.longitude).toFixed(7)}
lat: ${Cesium.Math.toDegrees(lastPickCarto.latitude).toFixed(7)}
h:   ${lastPickCarto.height.toFixed(3)} m`
        : 'n/a';
      const out = [
        `# BIM feature (click to cycle colors)`,
        ifcGuid?`IfcGUID: ${ifcGuid}`:null,
        ifcType?`Type:    ${ifcType}`:null,
        `\n# Pick position (WGS84)`,
        coordText,
        `\n# All properties`,
        JSON.stringify(props,null,2)
      ].filter(Boolean).join('\n');
      pickedInfo.textContent = out;
      const tbody=document.querySelector('#attrTable tbody');
      if(tbody){
        tbody.innerHTML='';
        Object.keys(props).sort().forEach(k=>{
          const tr=document.createElement('tr');
          tr.innerHTML=`<td style="vertical-align:top; padding:2px 6px; border-bottom:1px solid #f0f0f0">${escapeHtml(k)}</td><td style="vertical-align:top; padding:2px 6px; border-bottom:1px solid #f0f0f0; word-break:break-all">${escapeHtml(String(props[k]))}</td>`;
          tbody.appendChild(tr);
        });
      }
    }, Cesium.ScreenSpaceEventType.LEFT_CLICK);

    // Double-click to zoom near cursor
    handler.setInputAction((click)=>{
      const cart=viewer.scene.pickPosition(click.position);
      flyToCartesian(cart);
    }, Cesium.ScreenSpaceEventType.LEFT_DOUBLE_CLICK);

    // Right-click clears ALL highlights
    handler.setInputAction(()=>clearAllHighlights(), Cesium.ScreenSpaceEventType.RIGHT_CLICK);

    // Clear button
    (document.getElementById('btnClear')||{}).addEventListener?.('click', ()=> clearAllHighlights());

    // ===================== GUID / Room search via style =====================
    const guidInput=document.getElementById('guidInput');
    document.getElementById('btnGuid').addEventListener('click', ()=>{
      const guid=(guidInput.value||'').trim(); if(!guid){ tileset.style=undefined; return; }
      const pat=guid.replace(/'/g,"\\'");
      const conditions=[
        ["regexp('"+pat+"','i').test(${IfcGuid}) || regexp('"+pat+"','i').test(${GlobalId}) || regexp('"+pat+"','i').test(${IFC_GUID}) || regexp('"+pat+"','i').test(${elementId})","color('yellow',1.0)"],
        ["true","color('white',0.85)"]
      ];
      try{ tileset.style=new Cesium.Cesium3DTileStyle({color:{conditions}});}catch{ tileset.style=undefined; }
    });

    const roomInput=document.getElementById('roomInput');
    document.getElementById('btnRoom').addEventListener('click', ()=>{
      const name=(roomInput.value||'').trim(); if(!name) return; const pat=name.replace(/'/g,"\\'");
      const condMatch="(regexp('"+pat+"','i').test(${Name}) || regexp('"+pat+"','i').test(${LongName}) || regexp('"+pat+"','i').test(${Room})) && (regexp('IfcSpace','i').test(${IfcType}) || regexp('space|room','i').test(${class}))";
      const conditions=[[condMatch,"color('orange',1.0)"],["true","color('white',0.85)"]];
      try{ tileset.style=new Cesium.Cesium3DTileStyle({color:{conditions}});}catch{}
    });

    // ===================== Stats & Floors (grid sampling, no private APIs) =====================
    const seen=new Set(); const counts={windows:0,doors:0}; const storeys=new Map(); const roomsByStorey=new Map();

    function considerFeature(f){
      let guid; try { guid=f.getProperty('IfcGuid')||f.getProperty('GlobalId')||f.getProperty('elementId'); } catch {}
      if(guid&&seen.has(guid)) return; if(guid) seen.add(guid);
      const type=(()=>{ try { return (f.getProperty('IfcType')||f.getProperty('ifcClass')||f.getProperty('class')||f.getProperty('Type')||'').toString(); } catch { return ''; } })();
      const name=(()=>{ try { return (f.getProperty('Name')||f.getProperty('name')||f.getProperty('LongName')||'').toString(); } catch { return ''; } })();
      const storey=(()=>{ try { return (f.getProperty('Storey')||f.getProperty('Level')||f.getProperty('BuildingStorey')||f.getProperty('Floor')||'').toString(); } catch { return ''; } })();
      if(/IfcWindow/i.test(type) || /(\b|^)window\b/i.test(type)) counts.windows++;
      if(/IfcDoor/i.test(type) || /(\b|^)door\b/i.test(type)) counts.doors++;
      if(storey){ storeys.set(storey,(storeys.get(storey)||0)+1); }
      if(/IfcSpace/i.test(type) || /(\b|^)(space|room)\b/i.test(type)){
        const key=storey||'(No Storey)';
        if(!roomsByStorey.has(key)) roomsByStorey.set(key,new Set());
        if(name) roomsByStorey.get(key).add(name);
      }
    }

    function refreshStatsBox(){
      const levels=[...storeys.keys()].sort();
      let lines=`Windows: ${counts.windows} | Doors: ${counts.doors}`;
      if(levels.length){ lines+=`\nStoreys (${levels.length}):`; for(const lv of levels){ lines+=`\n- ${lv}: ${storeys.get(lv)} elemen`; } }
      statsBox.textContent=lines;
    }

    function renderLevelsPanel(){
      const el=document.getElementById('levelsPanel');
      if(!roomsByStorey.size){ el.textContent='(Tidak ada data ruang terdeteksi)'; return; }
      let html='';
      for(const [level,rooms] of roomsByStorey){
        html+=`<div style="margin:6px 0; font-weight:600;">${level}</div>`;
        const arr=Array.from(rooms).sort();
        html+=`<div style="display:flex; flex-wrap:wrap; gap:4px;">`+
          arr.map(r=>`<button class="room-btn" data-room="${r.replace(/"/g,'&quot;')}">${r}</button>`).join('')+
          `</div>`;
      }
      el.innerHTML=html;
      el.querySelectorAll('.room-btn').forEach(btn=>{
        btn.addEventListener('click', ()=>{
          el.querySelectorAll('.room-btn').forEach(b=>b.classList.remove('active'));
          btn.classList.add('active');
          const name=btn.getAttribute('data-room');
          roomInput.value=name;
          const pat=name.replace(/'/g,"\\'");
          const conditions=[["regexp('"+pat+"','i').test(${Name}) || regexp('"+pat+"','i').test(${LongName}) || regexp('"+pat+"','i').test(${Room})","color('orange',1.0)"],["true","color('white',0.85)"]];
          try{ tileset.style=new Cesium.Cesium3DTileStyle({color:{conditions}});}catch{}
        });
      });
    }

    document.getElementById('btnScan').addEventListener('click',()=>{
      seen.clear(); counts.windows=0; counts.doors=0; storeys.clear(); roomsByStorey.clear();

      // Grid-sample the canvas to gather a representative set of features without private APIs
      const w=viewer.canvas.clientWidth, h=viewer.canvas.clientHeight;
      const steps=10;
      for(let iy=1; iy<steps; iy++){
        for(let ix=1; ix<steps; ix++){
          const pt=new Cesium.Cartesian2(Math.round((ix/steps)*w),Math.round((iy/steps)*h));
          const picked=viewer.scene.drillPick(pt);
          for(const p of picked){ if(typeof p.getProperty!=='function') continue; try { considerFeature(p); } catch {} }
        }
      }

      refreshStatsBox();
      renderLevelsPanel();

      // Populate floor dropdown
      const dd=document.getElementById('floorFilter');
      const cur=dd.value;
      dd.innerHTML='<option value="">All</option>' + [...storeys.keys()].sort().map(lv=>`<option value="${lv.replace(/"/g,'&quot;')}">${lv}</option>`).join('');
      if([...storeys.keys()].includes(cur)) dd.value=cur;
    });

    (document.getElementById('btnFloor')||{}).addEventListener?.('click',()=>{
      const dd=document.getElementById('floorFilter');
      const lv=(dd&&dd.value?dd.value.trim():'');
      if(!lv){
        try{ tileset.style=new Cesium.Cesium3DTileStyle({color:{conditions:[["true","color('white',0.85)"]]}});}catch{}
        return;
      }
      const pat=lv.replace(/'/g,"\\'");
      const conditions=[["regexp('"+pat+"','i').test(${Storey}) || regexp('"+pat+"','i').test(${Level}) || regexp('"+pat+"','i').test(${BuildingStorey}) || regexp('"+pat+"','i').test(${Floor})","color('yellow',1.0)"],["true","color('white',0.2)"]];
      try{ tileset.style=new Cesium.Cesium3DTileStyle({color:{conditions}});}catch{}
    });

    // ===================== Self-tests =====================
    (function(){
      try{
        console.assert(!!Cesium, 'Cesium should be loaded');
        console.assert(!!viewer && !!viewer.scene, 'Viewer should be created');
        console.assert(typeof Cesium.Cesium3DTileset.fromIonAssetId==='function', 'fromIonAssetId available');
        console.log('[SELF-TEST] Basic environment OK');
      }catch(e){ console.error('[SELF-TEST] Failed:', e); }
    })();
  </script>
</body>
</html>
